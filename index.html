<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Numpang Ngopi CRB</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f5f2; }
    .hidden { display: none; }
    h1 { color: #4e342e; text-align: center; }
    h2 { color: #5d4037; border-bottom: 2px solid #d7ccc8; padding-bottom: 5px; }
    ul { list-style-type: none; padding: 0; }
    li { margin: 8px 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
    button { margin-top: 5px; padding: 5px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .done { color: green; font-weight: bold; }
    .pending { color: red; font-weight: bold; }
    #loginSection input { display: block; margin: 6px 0; padding: 8px; width: 200px; }
    #tvOrders li { font-size: 1.5em; font-weight: bold; text-align: center; }
    .btn-login { background: #6d4c41; color: white; }
    .btn-done { background: #4caf50; color: white; }
    .btn-delete { background: #e53935; color: white; }
    .btn-add { background: #8d6e63; color: white; }
  </style>
</head>
<body>
  <h1>â˜• #KopibeneranKopi</h1>

  <!-- LOGIN -->
  <div id="loginSection">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button class="btn-login" onclick="login()">Login</button>
  </div>

  <!-- KASIR -->
  <div id="kasirSection" class="hidden">
    <h2>Kasir - Input Transaksi</h2>
    <select id="menuKasir"></select>
    <input type="number" id="qtyKasir" placeholder="Jumlah" min="1">
    <button class="btn-add" onclick="addToCart()">Tambahkan ke Keranjang</button>
    <h3>Keranjang</h3>
    <ul id="cartList"></ul>
    <p><b>Total: Rp<span id="cartTotal">0</span></b></p>
    <p>Bayar: <input type="number" id="payment" placeholder="Jumlah bayar"></p>
    <p>Kembalian: Rp<span id="change">0</span></p>
    <button class="btn-add" onclick="checkout()">Checkout & Kirim Struk</button>
    <div id="kasirMsg"></div>
  </div>

  <!-- BARISTA -->
  <div id="baristaSection" class="hidden">
    <h2>Barista - Keranjang Pesanan</h2>
    <ul id="orderList"></ul>
  </div>

  <!-- OWNER -->
  <div id="ownerSection" class="hidden">
    <h2>Owner - Manajemen Menu</h2>
    <input type="text" id="menuOwner" placeholder="Menu Baru">
    <input type="number" id="hargaOwner" placeholder="Harga">
    <button class="btn-add" onclick="addMenu()">Tambah Menu</button>
    <h3>Daftar Menu</h3>
    <ul id="menuList"></ul>

    <h3>Laporan Harian</h3>
    <button onclick="laporanHarian()">Tarik Laporan Harian</button>
    <pre id="laporanHarian"></pre>

    <h3>Laporan Bulanan</h3>
    <button onclick="laporanBulanan()">Tarik Laporan Bulanan</button>
    <pre id="laporanBulanan"></pre>
  </div>

  <!-- TV ANTRIAN -->
  <div id="tvSection" class="hidden">
    <h2 style="text-align:center;">ðŸ“º TV Antrian</h2>
    <ul id="tvOrders"></ul>
  </div>

<script>
  // ---------- Firebase Config ----------
  const firebaseConfig = {
    databaseURL: "https://depelop-nnc-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- Login ----------
  function login() {
    let user = document.getElementById("username").value;
    let pass = document.getElementById("password").value;

    db.ref("users/" + user).once("value").then(snapshot => {
      let data = snapshot.val();
      if (data && data.password === pass) {
        sessionStorage.setItem("role", data.role);
        showSection(data.role);
        if (data.role === "kasir") loadMenus();
        if (data.role === "owner") loadMenusOwner();
      } else {
        alert("Login gagal!");
      }
    });
  }

  function showSection(role) {
    document.getElementById("loginSection").classList.add("hidden");
    if (role === "kasir") document.getElementById("kasirSection").classList.remove("hidden");
    if (role === "barista") {
      document.getElementById("baristaSection").classList.remove("hidden");
      listenOrders();
    }
    if (role === "owner") document.getElementById("ownerSection").classList.remove("hidden");
    if (role === "tv") {
      document.getElementById("tvSection").classList.remove("hidden");
      listenTV();
    }
  }

  // ---------- Kasir ----------
  function loadMenus() {
    db.ref("menus").once("value").then(snapshot => {
      let menuKasir = document.getElementById("menuKasir");
      menuKasir.innerHTML = "";
      snapshot.forEach(child => {
        let opt = document.createElement("option");
        opt.value = child.key;
        opt.textContent = `${child.key} - Rp${child.val().harga}`;
        menuKasir.appendChild(opt);
      });
    });
  }

  // ----- KASIR CART -----
  let cart = {};
  let total = 0;

  function addToCart() {
    let menu = document.getElementById("menuKasir").value;
    let qty = parseInt(document.getElementById("qtyKasir").value);
    if (!qty || qty <= 0) return alert("Jumlah tidak valid!");

    db.ref("menus/" + menu).once("value").then(snapshot => {
      let harga = snapshot.val().harga;
      if (!cart[menu]) cart[menu] = { qty: 0, harga: harga };
      cart[menu].qty += qty;
      updateCart();
    });
  }

  function updateCart() {
    let cartList = document.getElementById("cartList");
    cartList.innerHTML = "";
    total = 0;

    Object.keys(cart).forEach(menu => {
      let item = cart[menu];
      let subtotal = item.qty * item.harga;
      total += subtotal;

      let li = document.createElement("li");
      li.textContent = `${menu} ${item.qty} x ${item.harga} = Rp${subtotal}`;
      cartList.appendChild(li);
    });

    document.getElementById("cartTotal").innerText = total;

    // Hitung kembalian otomatis
    let bayar = parseInt(document.getElementById("payment").value) || 0;
    document.getElementById("change").innerText = bayar - total >= 0 ? (bayar - total) : 0;
  }

  document.getElementById("payment").addEventListener("input", updateCart);

  function checkout() {
    if (total <= 0) return alert("Keranjang kosong!");
    let bayar = parseInt(document.getElementById("payment").value);
    if (!bayar || bayar < total) return alert("Pembayaran kurang!");

    // Simpan ke Firebase orders
    let newOrder = db.ref("orders").push();
    newOrder.set({
      items: cart,
      total: total,
      status: "pending",
      time: new Date().toISOString()
    });

    // Buat struk
    let struk = "â˜• Numpang Ngopi CRB\n";
    struk += "=====================\n";
    Object.keys(cart).forEach(menu => {
      let item = cart[menu];
      let subtotal = item.qty * item.harga;
      struk += `${menu} ${item.qty} x ${item.harga} = Rp${subtotal}\n`;
    });
    struk += "---------------------\n";
    struk += `Total: Rp${total}\nBayar: Rp${bayar}\nKembali: Rp${bayar - total}\n`;
    struk += "=====================\nTerima kasih! #KopibeneranKopi";

    // Kirim ke WhatsApp pelanggan
    let phone = prompt("Masukkan nomor WhatsApp pelanggan (contoh: 628123456789):");
    if (phone) {
      let url = `https://wa.me/${phone}?text=${encodeURIComponent(struk)}`;
      window.open(url, "_blank");
    }

    // Reset keranjang
    cart = {};
    updateCart();
    document.getElementById("payment").value = "";
    alert("Pesanan dikirim ke Barista!");
  }

  // ---------- Barista ----------
  function listenOrders() {
    db.ref("orders").on("value", snapshot => {
      let list = document.getElementById("orderList");
      list.innerHTML = "";
      snapshot.forEach(child => {
        let order = child.val();
        let li = document.createElement("li");
        if (order.items) {
          li.innerHTML = `<b>Pesanan</b><br>`;
          Object.keys(order.items).forEach(m => {
            let it = order.items[m];
            li.innerHTML += `- ${m} ${it.qty}x<br>`;
          });
          li.innerHTML += `<b>Total: Rp${order.total}</b> `;
        } else {
          li.innerHTML = `<b>${order.menu}</b> x ${order.qty}`;
        }
        li.innerHTML += ` <span class="${order.status}">[${order.status}]</span>`;
        if (order.status === "pending") {
          li.innerHTML += ` <button class="btn-done" onclick="doneOrder('${child.key}')">Selesai</button>`;
        }
        list.appendChild(li);
      });
    });
  }

  function doneOrder(id) {
    db.ref("orders/" + id).update({ status: "done" });
  }

  // ---------- Owner ----------
  function addMenu() {
    let menu = document.getElementById("menuOwner").value;
    let harga = document.getElementById("hargaOwner").value;
    db.ref("menus/" + menu).set({ harga: parseInt(harga) });
    loadMenusOwner();
    alert("Menu ditambahkan!");
  }

  function loadMenusOwner() {
    db.ref("menus").once("value").then(snapshot => {
      let menuList = document.getElementById("menuList");
      menuList.innerHTML = "";
      snapshot.forEach(child => {
        let li = document.createElement("li");
        li.innerHTML = `${child.key} - Rp${child.val().harga}
          <button class="btn-delete" onclick="deleteMenu('${child.key}')">Hapus</button>`;
        menuList.appendChild(li);
      });
    });
  }

  function deleteMenu(menu) {
    db.ref("menus/" + menu).remove();
    loadMenusOwner();
  }

  function laporanHarian() {
    let today = new Date().toISOString().split("T")[0];
    db.ref("orders").once("value").then(snapshot => {
      let hasil = [];
      snapshot.forEach(child => {
        let o = child.val();
        if (o.time.startsWith(today)) hasil.push(o);
      });
      document.getElementById("laporanHarian").textContent = JSON.stringify(hasil, null, 2);
    });
  }

  function laporanBulanan() {
    let ym = new Date().toISOString().slice(0,7);
    db.ref("orders").once("value").then(snapshot => {
      let hasil = [];
      snapshot.forEach(child => {
        let o = child.val();
        if (o.time.startsWith(ym)) hasil.push(o);
      });
      document.getElementById("laporanBulanan").textContent = JSON.stringify(hasil, null, 2);
    });
  }

  // ---------- TV Antrian ----------
  function listenTV() {
    db.ref("orders").on("value", snapshot => {
      let list = document.getElementById("tvOrders");
      list.innerHTML = "";
      snapshot.forEach(child => {
        let order = child.val();
        let li = document.createElement("li");
        if (order.items) {
          li.innerHTML = `<b>Pesanan</b><br>`;
          Object.keys(order.items).forEach(m => {
            let it = order.items[m];
            li.innerHTML += `- ${m} ${it.qty}x<br>`;
          });
          li.innerHTML += `<b>Total: Rp${order.total}</b> `;
        } else {
          li.innerHTML = `${order.menu} x ${order.qty}`;
        }
        li.innerHTML += ` <span class="${order.status}">[${order.status}]</span>`;
        list.appendChild(li);
      });
    });
  }

  // ---------- Tambahkan Menu Default ----------
  const defaultMenus = {
    "kopi susu gula aren": { harga: 8000 },
    "kopi susu latte": { harga: 8000 },
    "americano": { harga: 6000 },
    "capuchino": { harga: 10000 },
    "taro coffe": { harga: 10000 },
    "taro latte": { harga: 8000 },
    "coklat latte": { harga: 8000 },
    "redvelvet latte": { harga: 8000 },
    "Creamy": { harga: 1000 },
    "Aren": { harga: 1000 },
    "Es Batu": { harga: 1000 }
  };

  db.ref("menus").once("value").then(snapshot => {
    if (!snapshot.exists()) {
      db.ref("menus").set(defaultMenus);
    }
  });
</script>
</body>
</html>
