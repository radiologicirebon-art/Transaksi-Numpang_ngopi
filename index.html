<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaksi Numpang Ngopi.crb</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // --- Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      databaseURL: "https://sistem-kasir-numpang-ngopi-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Data Menu ---
    const menus = {
      "Menu Premium": [
        { name: "Kopi Gula Aren", price: 10000 },
        { name: "Kopi Latte", price: 10000 },
        { name: "Kopi Chapuchino", price: 12000 },
        { name: "Kopi Stefia", price: 10000 }
      ],
      "Menu Keliling": [
        { name: "Kopi Aren", price: 8000 },
        { name: "Kopi Latte", price: 8000 }
      ],
      "Non Coffe Premium": [
        { name: "Tarro Latte*", price: 10000 },
        { name: "Red Velvet Latte*", price: 10000 },
        { name: "Chocolatte*", price: 10000 },
        { name: "Brownsugar Milk", price: 10000 }
      ],
      "Non Coffe Keliling": [
        { name: "Tarro", price: 5000 },
        { name: "Redvelvet", price: 5000 },
        { name: "Coklat", price: 5000 },
        { name: "Gula Ren Milk", price: 5000 }
      ]
    };

    let cart = [];

    // --- Render Menu ---
    window.addEventListener("DOMContentLoaded", () => {
      const menuContainer = document.getElementById("menu");
      for (let kategori in menus) {
        const section = document.createElement("div");
        section.className = "bg-white shadow rounded-2xl p-4 mb-6";
        section.innerHTML = `<h2 class="text-lg font-semibold mb-3">${kategori}</h2>`;
        const grid = document.createElement("div");
        grid.className = "grid grid-cols-2 gap-3";
        menus[kategori].forEach(item => {
          const btn = document.createElement("button");
          btn.className = "bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl py-3 px-2 text-sm";
          btn.textContent = `${item.name} - Rp ${item.price.toLocaleString()}`;
          btn.onclick = () => addToCart(item);
          grid.appendChild(btn);
        });
        section.appendChild(grid);
        menuContainer.appendChild(section);
      }
      refreshCart();
    });

    // --- Cart Functions ---
    function addToCart(item) {
      let found = cart.find(c => c.name === item.name);
      if (found) found.qty++;
      else cart.push({ ...item, qty: 1 });
      refreshCart();
    }

    function removeItem(i) {
      cart.splice(i, 1);
      refreshCart();
    }

    function clearCart() {
      cart = [];
      refreshCart();
    }

    function refreshCart() {
      const cartDiv = document.getElementById("cart");
      cartDiv.innerHTML = "";
      let total = 0, itemCount = 0;
      cart.forEach((item, i) => {
        total += item.price * item.qty;
        itemCount += item.qty;
        const row = document.createElement("div");
        row.className = "flex justify-between items-center py-1 border-b";
        row.innerHTML = `
          <span>${item.name} x${item.qty}</span>
          <span>Rp ${(item.price*item.qty).toLocaleString()}</span>
          <button class="text-red-500" onclick="removeItem(${i})">✕</button>
        `;
        cartDiv.appendChild(row);
      });
      document.getElementById("total").textContent = total.toLocaleString();
      document.getElementById("itemCount").textContent = itemCount;
      const bayar = parseInt(document.getElementById("paidAmount").value) || 0;
      document.getElementById("change").textContent = (bayar - total >= 0 ? (bayar - total).toLocaleString() : "0");
    }

    window.removeItem = removeItem;
    window.clearCart = clearCart;

    // --- Save Transaction to Firebase ---
    window.saveTransaction = function () {
      if (cart.length === 0) return alert("Keranjang kosong!");
      const total = document.getElementById("total").textContent;
      const bayar = document.getElementById("paidAmount").value;
      const kembali = document.getElementById("change").textContent;

      const transaksiRef = push(ref(db, "transaksi"));
      set(transaksiRef, {
        items: cart,
        total: total,
        bayar: bayar,
        kembali: kembali,
        timestamp: new Date().toISOString()
      });

      alert("✅ Transaksi tersimpan!");
      clearCart();
      document.getElementById("paidAmount").value = "";
    }

    // --- Cetak Struk ---
    window.printReceipt = function () {
      let total = document.getElementById("total").textContent;
      let bayar = document.getElementById("paidAmount").value || "0";
      let kembali = document.getElementById("change").textContent;
      let content = `
        Numpang Ngopi.crb\n#Kopinyabenerankopi.\n\n
        ${cart.map(i => `${i.name} x${i.qty} = Rp ${(i.price*i.qty).toLocaleString()}`).join("\n")}
        -----------------------------\n
        Total: Rp ${total}\nBayar: Rp ${bayar}\nKembali: Rp ${kembali}\n
        Terima kasih 🙏
      `;
      let w = window.open("", "", "width=400,height=600");
      w.document.write(`<pre>${content}</pre>`);
      w.print();
    }

    // --- Kirim WhatsApp ---
    window.sendWhatsApp = function () {
      let nohp = prompt("Masukkan nomor WhatsApp (contoh: 089xxxx)");
      if (!nohp) return;
      let total = document.getElementById("total").textContent;
      let bayar = document.getElementById("paidAmount").value || "0";
      let kembali = document.getElementById("change").textContent;
      let pesan = `Numpang Ngopi.crb%0A#Kopinyabenerankopi.%0A%0A${cart.map(i => `${i.name} x${i.qty} = Rp ${(i.price*i.qty).toLocaleString()}`).join("%0A")}%0A--------------------%0ATotal: Rp ${total}%0ABayar: Rp ${bayar}%0AKembali: Rp ${kembali}%0A%0ATerima kasih 🙏`;
      window.open(`https://wa.me/${nohp}?text=${pesan}`, "_blank");
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-emerald-700 text-white p-4 text-center shadow">
    <h1 class="text-xl font-bold">Transaksi Numpang Ngopi.crb</h1>
    <marquee class="text-sm">#Kopinyabenerankopi.</marquee>
  </header>

  <!-- Main Content -->
  <main id="menu" class="flex-1 p-4 overflow-y-auto"></main>

  <!-- Cart -->
  <div class="bg-white shadow-2xl p-4 rounded-t-2xl">
    <h2 class="text-lg font-semibold mb-2">Keranjang</h2>
    <div id="cart" class="max-h-40 overflow-y-auto mb-2"></div>
    <div class="text-sm space-y-1">
      <p><b>Total:</b> Rp <span id="total">0</span></p>
      <p><b>Jumlah Item:</b> <span id="itemCount">0</span></p>
      <p><b>Pembayar:</b></p>
      <input type="number" id="paidAmount" oninput="refreshCart()" class="w-full border rounded px-2 py-1" placeholder="Jumlah bayar">
      <p><b>Kembalian:</b> Rp <span id="change">0</span></p>
    </div>
    <div class="grid grid-cols-2 gap-2 mt-3">
      <button onclick="saveTransaction()" class="bg-emerald-600 text-white py-2 rounded-xl">💾 Simpan</button>
      <button onclick="clearCart()" class="bg-red-500 text-white py-2 rounded-xl">🗑 Bersihkan</button>
      <button onclick="printReceipt()" class="bg-yellow-400 text-black py-2 rounded-xl">🖨 Cetak Struk</button>
      <button onclick="sendWhatsApp()" class="bg-blue-500 text-white py-2 rounded-xl">📱 Kirim WA</button>
    </div>
  </div>
</body>
</html>
