<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Numpang Ngopi.crb ‚Äî Kasir</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1d899b;
      --primary-dark: #156b78;
      --danger: #e53935;
      --danger-dark: #c62828;
      --warning: #fbc02d;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #333;
    }
    * { box-sizing: border-box; }
    body { font-family: "Poppins", sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text);}
    header { background: var(--primary); color: #fff; padding: 20px; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
    header h1 { margin: 0; font-size: 22px; font-weight: 600; }
    header p { margin: 5px 0 0; font-size: 14px; opacity: 0.9; }
    main { padding: 20px; max-width: 1000px; margin: auto; display: grid; gap: 20px;}
    .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);}
    .card h2 { margin-top: 0; font-size: 18px; font-weight: 600; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    button { cursor: pointer; border: none; border-radius: 8px; padding: 8px 14px; font-size: 14px; font-weight: 500; transition: background 0.2s ease-in-out;}
    .btn-primary { background: var(--primary); color:#fff;}
    .btn-primary:hover { background: var(--primary-dark);}
    .btn-danger { background: var(--danger); color:#fff;}
    .btn-danger:hover { background: var(--danger-dark);}
    .btn-warning { background: var(--warning); color:#000;}
    input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; margin: 5px 0; font-size: 14px;}
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    .menu-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .menu-actions button { margin-left: 6px; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding: 8px; border-bottom: 1px solid #eee;}
    .summary { margin-top: 15px; font-size: 14px; background: #f9f9f9; padding: 12px; border-radius: 8px;}
    .summary p { margin: 6px 0; }
  </style>
</head>
<body>
  <header>
    <h1>Numpang Ngopi.crb ‚Äî Kasir</h1>
    <p>Sistem kasir sederhana untuk kedai</p>
  </header>

  <main>
    <!-- Manajemen Menu -->
    <div class="card">
      <h2>Daftar Menu</h2>
      <div id="menu"></div>
      <hr>
      <h3>Tambah / Edit Produk</h3>
      <input type="hidden" id="editKey">
      <input type="text" id="dbName" placeholder="Nama produk">
      <input type="number" id="dbPrice" placeholder="Harga (contoh: 8000)">
      <div class="btn-row">
        <button class="btn-primary" onclick="Menu.saveProduct()">üíæ Simpan</button>
        <button class="btn-warning" onclick="Menu.resetForm()">‚Ü© Batal</button>
      </div>
    </div>

    <!-- Keranjang -->
    <div class="card">
      <h2>Keranjang</h2>
      <div id="cart"></div>
      <div class="summary">
        <p><strong>Total:</strong> Rp <span id="total">0</span></p>
        <p><strong>Pembayar:</strong></p>
        <input type="number" id="paidAmount" placeholder="Jumlah bayar">
        <p><strong>Kembalian:</strong> Rp <span id="change">0</span></p>
        <p><strong>Jumlah Item:</strong> <span id="itemCount">0</span></p>
      </div>
      <div class="btn-row">
        <button class="btn-primary" onclick="Cart.save()">üíæ Simpan</button>
        <button class="btn-warning" onclick="Cart.clear()">üßπ Bersihkan</button>
        <button class="btn-primary" onclick="Cart.printReceipt()">üñ® Cetak Struk</button>
      </div>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Konfigurasi Firebase
    const firebaseConfig = {
      databaseURL: "https://ka34332-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ================= MENU =================
    const Menu = {
      list: [],
      load() {
        const menuRef = ref(db, "menu");
        onValue(menuRef, (snapshot) => {
          this.list = [];
          document.getElementById("menu").innerHTML = "";
          snapshot.forEach((child) => {
            let key = child.key;
            let item = child.val();
            this.list.push({ ...item, key });
            Menu.renderItem(item, key);
          });
        });
      },
      renderItem(item, key) {
        const wrapper = document.createElement("div");
        wrapper.className = "menu-item";
        wrapper.innerHTML = `
          <span>${item.name} (Rp${item.price})</span>
          <div class="menu-actions">
            <button class="btn-primary" onclick='Cart.add(${JSON.stringify(item)})'>Tambah</button>
            <button class="btn-warning" onclick="Menu.edit('${key}', '${item.name}', ${item.price})">Edit</button>
            <button class="btn-danger" onclick="Menu.delete('${key}')">Hapus</button>
          </div>
        `;
        document.getElementById("menu").appendChild(wrapper);
      },
      saveProduct() {
        const name = document.getElementById("dbName").value.trim();
        const price = parseInt(document.getElementById("dbPrice").value);
        const editKey = document.getElementById("editKey").value;

        if (!name || !price) return alert("Isi nama dan harga dengan benar!");

        if (editKey) {
          const itemRef = ref(db, "menu/" + editKey);
          update(itemRef, { name, price });
          alert("Produk berhasil diperbarui!");
        } else {
          const menuRef = ref(db, "menu");
          const newItemRef = push(menuRef);
          set(newItemRef, { name, price });
          alert("Produk berhasil ditambahkan!");
        }
        this.resetForm();
      },
      edit(key, name, price) {
        document.getElementById("editKey").value = key;
        document.getElementById("dbName").value = name;
        document.getElementById("dbPrice").value = price;
      },
      delete(key) {
        if (confirm("Yakin hapus produk ini?")) {
          const itemRef = ref(db, "menu/" + key);
          remove(itemRef);
        }
      },
      resetForm() {
        document.getElementById("editKey").value = "";
        document.getElementById("dbName").value = "";
        document.getElementById("dbPrice").value = "";
      }
    };

    // ================= CART =================
    const Cart = {
      list: [],
      add(item) {
        let found = this.list.find(c => c.name === item.name);
        if (found) found.qty++;
        else this.list.push({ ...item, qty: 1 });
        this.refresh();
      },
      remove(i) {
        this.list.splice(i, 1);
        this.refresh();
      },
      clear() {
        this.list = [];
        this.refresh();
      },
      refresh() {
        const cartDiv = document.getElementById("cart");
        cartDiv.innerHTML = "";
        let total = 0, itemCount = 0;

        this.list.forEach((item, i) => {
          let line = document.createElement("div");
          line.className = "cart-item";
          line.innerHTML = `
            <span>${item.name} x${item.qty} ‚Äî Rp${item.price * item.qty}</span>
            <button class="btn-danger" onclick="Cart.remove(${i})">Hapus</button>`;
          cartDiv.appendChild(line);
          total += item.price * item.qty;
          itemCount += item.qty;
        });

        document.getElementById("total").textContent = total;
        document.getElementById("itemCount").textContent = itemCount;
        const paidAmount = parseInt(document.getElementById("paidAmount").value) || 0;
        document.getElementById("change").textContent = paidAmount - total >= 0 ? paidAmount - total : 0;
      },
      save() {
        alert("Transaksi disimpan (simulasi). Total: Rp " + document.getElementById("total").textContent);
        this.clear();
        document.getElementById("paidAmount").value = "";
      },
      printReceipt() {
        let w = window.open('', '', 'width=400,height=600');
        let total = document.getElementById("total").textContent;
        let paid = document.getElementById("paidAmount").value || 0;
        let change = paid - total;
        let receipt = `
          <html>
            <head>
              <title>Struk Numpang Ngopi.crb</title>
              <style>
                body { font-family: monospace; padding: 10px; font-size: 13px; }
                h2 { text-align: center; margin-bottom: 10px; }
                hr { border: none; border-top: 1px dashed #000; margin: 10px 0; }
              </style>
            </head>
            <body>
              <h2>Numpang Ngopi.crb</h2>
              <div>${this.list.map(item => `${item.name} - Rp${item.price} x ${item.qty} = Rp${item.price*item.qty}`).join("<br>")}</div>
              <hr>
              <p>Total: Rp ${total}</p>
              <p>Bayar: Rp ${paid}</p>
              <p>Kembali: Rp ${change}</p>
              <hr>
              <p style="text-align:center;">Terima Kasih üôè</p>
            </body>
          </html>
        `;
        w.document.write(receipt);
        w.document.close();
        w.print();
      }
    };

    // Event listener perubahan jumlah bayar
    document.getElementById("paidAmount").oninput = () => Cart.refresh();

    // Load menu awal
    Menu.load();
  </script>
</body>
</html>
