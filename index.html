<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Numpang Ngopi CRB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js -->

  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: linear-gradient(135deg, #f5ebe0, #e9d5ca); color: #3e2723;
      min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    h1 { color: #3e2723; text-align: center; font-size: 2rem; margin-bottom: 15px; }
    h2 { color: #5d4037; border-left: 6px solid #d7ccc8; padding-left: 10px; font-size: 1.3rem; margin-bottom: 15px; }
    .hidden { display: none; }
    .card { background: #fff; border-radius: 15px; padding: 20px; margin: 15px 0; width: 100%; max-width: 600px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1); }
    ul { list-style-type: none; padding: 0; }
    li { margin: 10px 0; padding: 12px 15px; border: 1px solid #eee; border-radius: 12px; background: #fafafa; }
    input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 10px; font-size: 1rem; }
    button { margin-top: 8px; padding: 12px 18px; border: none; border-radius: 10px; cursor: pointer;
      font-size: 1rem; font-weight: bold; width: 100%; }
    .btn-login { background: #6d4c41; color: white; }
    .btn-add { background: #8d6e63; color: white; }
    .btn-done { background: #4caf50; color: white; }
    .btn-delete { background: #e53935; color: white; }
    .done { color: #2e7d32; font-weight: bold; }
    .pending { color: #d84315; font-weight: bold; }
  </style>
</head>
<body>
  <h1>☕ #KopibeneranKopi</h1>

  <!-- LOGIN -->
  <div id="loginSection" class="card">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="👤 Username">
    <input type="password" id="password" placeholder="🔒 Password">
    <button class="btn-login" onclick="login()">Login</button>
  </div>

  <!-- NAVIGASI ROLE -->
  <div id="navSection" class="hidden card">
    <h2>Pindah Role</h2>
    <button onclick="showSection('kasir')">Kasir</button>
    <button onclick="showSection('barista')">Barista</button>
    <button onclick="showSection('tv')">TV</button>
    <button onclick="showSection('owner')">Owner</button>
    <button onclick="logout()">🚪 Logout</button>
  </div>

  <!-- KASIR -->
  <div id="kasirSection" class="hidden card">
    <h2>Kasir - Input Transaksi</h2>
    <select id="menuKasir"></select>
    <input type="number" id="qtyKasir" placeholder="Jumlah" min="1">
    <button class="btn-add" onclick="addToCart()">➕ Tambahkan ke Keranjang</button>
    <h3>🛒 Keranjang</h3>
    <ul id="cartList"></ul>
    <p><b>Total: Rp<span id="cartTotal">0</span></b></p>
    <p>Bayar: <input type="number" id="payment" placeholder="Jumlah bayar"></p>
    <p>Kembalian: Rp<span id="change">0</span></p>
    <button class="btn-add" onclick="checkout()">✅ Checkout & Kirim Struk</button>
  </div>

  <!-- BARISTA -->
  <div id="baristaSection" class="hidden card">
    <h2>Barista - Keranjang Pesanan</h2>
    <ul id="orderList"></ul>
  </div>

  <!-- OWNER -->
  <div id="ownerSection" class="hidden card">
    <h2>Owner - Manajemen Menu</h2>
    <input type="text" id="menuOwner" placeholder="☕ Menu Baru">
    <input type="number" id="hargaOwner" placeholder="💰 Harga">
    <button class="btn-add" onclick="addMenu()">Tambah Menu</button>
    <h3>📋 Daftar Menu</h3>
    <ul id="menuList"></ul>

    <h3>📊 Dashboard Owner</h3>
    <canvas id="chartOrdersHour" height="150"></canvas>
    <canvas id="chartOrdersDay" height="150"></canvas>

    <!-- 🎯 Target Harian -->
    <h3>🎯 Target Harian</h3>
    <input type="number" id="dailyTarget" placeholder="Target cup/hari" min="1">
    <button class="btn-add" onclick="updateTarget()">Update Target</button>
    <p id="targetInfo">✅ Pesanan selesai: 0 / 30 (0%)</p>
  </div>

  <!-- TV ANTRIAN -->
  <div id="tvSection" class="hidden card">
    <h2 style="text-align:center;">📺 TV Antrian</h2>
    <ul id="tvOrders"></ul>
  </div>

  <!-- Suara Notifikasi -->
  <audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
  // ---------- Firebase ----------
  const firebaseConfig = { databaseURL: "https://depelop-nnc-default-rtdb.firebaseio.com/" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- Login ----------
  function login() {
    let user = document.getElementById("username").value;
    let pass = document.getElementById("password").value;
    db.ref("users/" + user).once("value").then(snapshot => {
      let data = snapshot.val();
      if (data && data.password === pass) {
        sessionStorage.setItem("role", data.role);
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("navSection").classList.remove("hidden");
        showSection(data.role);
        if (data.role === "kasir") loadMenus();
        if (data.role === "owner") { loadMenusOwner(); loadDashboard(); checkDailyReset(); }
        if (data.role === "kasir" || data.role === "tv") listenNotifications();
      } else { alert("Login gagal!"); }
    });
  }

  function logout() { sessionStorage.clear(); location.reload(); }

  // ---------- Navigasi Role ----------
  function hideAll() {
    ["kasirSection","baristaSection","ownerSection","tvSection"].forEach(id => {
      document.getElementById(id).classList.add("hidden");
    });
  }
  function showSection(role) {
    hideAll();
    if (role === "kasir") { document.getElementById("kasirSection").classList.remove("hidden"); loadMenus(); }
    if (role === "barista") { document.getElementById("baristaSection").classList.remove("hidden"); listenOrders(); }
    if (role === "owner") { document.getElementById("ownerSection").classList.remove("hidden"); loadMenusOwner(); loadDashboard(); checkDailyReset(); }
    if (role === "tv") { document.getElementById("tvSection").classList.remove("hidden"); listenTV(); }
  }

  // ---------- Kasir ----------
  let cart = {}, total = 0;
  function loadMenus() {
    db.ref("menus").once("value").then(snapshot => {
      let menuKasir = document.getElementById("menuKasir");
      menuKasir.innerHTML = "";
      snapshot.forEach(m => {
        let opt = document.createElement("option");
        opt.value = m.key;
        opt.textContent = m.key + " - Rp" + m.val().harga;
        menuKasir.appendChild(opt);
      });
    });
  }
  function addToCart() {
    let menu = document.getElementById("menuKasir").value;
    let qty = parseInt(document.getElementById("qtyKasir").value);
    if (!qty || qty <= 0) return alert("Jumlah tidak valid!");
    db.ref("menus/" + menu).once("value").then(snapshot => {
      let harga = snapshot.val().harga;
      if (!cart[menu]) cart[menu] = { qty: 0, harga: harga };
      cart[menu].qty += qty;
      total += harga * qty;
      updateCart();
    });
  }
  function updateCart() {
    let list = document.getElementById("cartList");
    list.innerHTML = "";
    for (let m in cart) {
      let li = document.createElement("li");
      li.textContent = `${m} x${cart[m].qty} = Rp${cart[m].qty * cart[m].harga}`;
      list.appendChild(li);
    }
    document.getElementById("cartTotal").textContent = total;
  }
  function checkout() {
    if (total === 0) return alert("Keranjang kosong!");
    let bayar = parseInt(document.getElementById("payment").value);
    if (!bayar || bayar < total) return alert("Nominal bayar kurang!");
    let change = bayar - total;
    document.getElementById("change").textContent = change;
    let orderId = "ORD" + Date.now();
    db.ref("orders/" + orderId).set({ items: cart, total: total, status: "pending", time: new Date().toISOString() });
    alert("✅ Pesanan berhasil dicatat & struk terkirim");
    cart = {}; total = 0; updateCart(); document.getElementById("cartTotal").textContent = 0;
    document.getElementById("payment").value = ""; document.getElementById("change").textContent = 0;
  }

  // ---------- Barista ----------
  function listenOrders() {
    db.ref("orders").on("value", snapshot => {
      let list = document.getElementById("orderList");
      list.innerHTML = "";
      snapshot.forEach(o => {
        let order = o.val();
        let li = document.createElement("li");
        li.innerHTML = `📝 <b>${o.key}</b><br>Total: Rp${order.total}<br>Status: <span class="${order.status === "done" ? "done" : "pending"}">${order.status}</span>`;
        if (order.status === "pending") {
          let btn = document.createElement("button");
          btn.className = "btn-done";
          btn.textContent = "Selesaikan Pesanan";
          btn.onclick = () => doneOrder(o.key);
          li.appendChild(btn);
        }
        list.appendChild(li);
      });
    });
  }
  function doneOrder(id) { db.ref("orders/" + id).update({ status: "done" }); }

  // ---------- Owner Menu ----------
  function addMenu() {
    let menu = document.getElementById("menuOwner").value.toLowerCase();
    let harga = parseInt(document.getElementById("hargaOwner").value);
    if (!menu || !harga) return alert("Menu/harga tidak valid!");
    db.ref("menus/" + menu).set({ harga: harga });
    document.getElementById("menuOwner").value = "";
    document.getElementById("hargaOwner").value = "";
    loadMenusOwner();
  }
  function loadMenusOwner() {
    db.ref("menus").once("value").then(snapshot => {
      let list = document.getElementById("menuList");
      list.innerHTML = "";
      snapshot.forEach(m => {
        let li = document.createElement("li");
        li.innerHTML = `${m.key} - Rp${m.val().harga} <button class="btn-delete" onclick="deleteMenu('${m.key}')">Hapus</button>`;
        list.appendChild(li);
      });
    });
  }
  function deleteMenu(menu) { db.ref("menus/" + menu).remove(); loadMenusOwner(); }

  // ---------- Dashboard Owner + Target Harian ----------
  const targetRef = db.ref("settings/dailyTarget");
  const resetRef = db.ref("settings/lastResetDate");
  const reportsRef = db.ref("reports");

  function checkDailyReset() {
    let today = new Date().toISOString().split("T")[0];
    resetRef.once("value").then(snapshot => {
      let lastReset = snapshot.val();
      if (lastReset && lastReset !== today) {
        Promise.all([targetRef.once("value"), db.ref("orders").once("value")]).then(([targetSnap, ordersSnap]) => {
          let target = targetSnap.val() || 30;
          let selesai = 0;
          ordersSnap.forEach(o => { if (o.val().status === "done") selesai++; });
          reportsRef.child(lastReset).set({ target: target, selesai: selesai });
        });
      }
      if (lastReset !== today) {
        targetRef.set(30); resetRef.set(today);
        document.getElementById("dailyTarget").value = 30;
        document.getElementById("targetInfo").innerText = `🎯 Target reset otomatis ke 30 cup (tanggal ${today})`;
      }
    });
  }

  targetRef.on("value", snapshot => {
    if (snapshot.exists()) {
      document.getElementById("dailyTarget").value = snapshot.val();
      calculatePercentage();
    } else { targetRef.set(30); document.getElementById("dailyTarget").value = 30; }
  });

  function updateTarget() {
    let newTarget = parseInt(document.getElementById("dailyTarget").value);
    if (!newTarget || newTarget <= 0) return alert("Target tidak valid!");
    targetRef.set(newTarget); alert("Target harian diperbarui ✅");
  }

  function calculatePercentage() {
    Promise.all([db.ref("orders").once("value"), targetRef.once("value")]).then(([ordersSnap, targetSnap]) => {
      let target = targetSnap.val() || 30; let selesai = 0;
      ordersSnap.forEach(o => { if (o.val().status === "done") selesai++; });
      let persen = ((selesai / target) * 100).toFixed(1);
      document.getElementById("targetInfo").innerText = `✅ Pesanan selesai: ${selesai} / ${target} (${persen}%)`;
    });
  }

  function loadDashboard() {
    db.ref("orders").on("value", snapshot => {
      let perJam = {}; let perHari = {};
      snapshot.forEach(o => {
        let order = o.val();
        let d = new Date(order.time);
        let jam = d.getHours(); let hari = d.toISOString().split("T")[0];
        if (!perJam[jam]) perJam[jam] = { masuk: 0, selesai: 0 };
        if (!perHari[hari]) perHari[hari] = { masuk: 0, selesai: 0 };
        perJam[jam].masuk++; perHari[hari].masuk++;
        if (order.status === "done") { perJam[jam].selesai++; perHari[hari].selesai++; }
      });
      // Chart per jam
      let ctxHour = document.getElementById("chartOrdersHour").getContext("2d");
      new Chart(ctxHour, { type: "bar", data: {
        labels: Object.keys(perJam), datasets: [
          { label: "Masuk", data: Object.values(perJam).map(v => v.masuk), backgroundColor: "rgba(255,159,64,0.7)" },
          { label: "Selesai", data: Object.values(perJam).map(v => v.selesai), backgroundColor: "rgba(75,192,192,0.7)" }
        ] } });
      // Chart per hari
      let ctxDay = document.getElementById("chartOrdersDay").getContext("2d");
      new Chart(ctxDay, { type: "line", data: {
        labels: Object.keys(perHari), datasets: [
          { label: "Masuk", data: Object.values(perHari).map(v => v.masuk), borderColor: "orange", fill: false },
          { label: "Selesai", data: Object.values(perHari).map(v => v.selesai), borderColor: "green", fill: false }
        ] } });
    });
  }

  // ---------- TV ----------
  function listenTV() {
    db.ref("orders").on("value", snapshot => {
      let list = document.getElementById("tvOrders");
      list.innerHTML = "";
      snapshot.forEach(o => {
        let order = o.val();
        let li = document.createElement("li");
        li.textContent = `${o.key} - Rp${order.total} (${order.status})`;
        list.appendChild(li);
      });
    });
  }

  // ---------- Notifikasi ----------
  function listenNotifications() {
    db.ref("orders").on("child_changed", snapshot => {
      let order = snapshot.val();
      if (order.status === "done") {
        alert("✅ Pesanan Selesai!\nTotal: Rp" + order.total);
        document.getElementById("notifSound").play().catch(e => console.log("Autoplay dicegah:", e));
      }
    });
<script>
  // ---------- Firebase ----------
  const firebaseConfig = { databaseURL: "https://depelop-nnc-default-rtdb.firebaseio.com/" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- Menu Default ----------
  const defaultMenus = {
    "kopi susu gula aren": { harga: 8000 },
    "americano": { harga: 6000 },
    "cappuccino": { harga: 10000 },
    "taro latte": { harga: 8000 },
    "choco latte": { harga: 8000 },
    "redvelvet latte": { harga: 8000 },
    "espresso": { harga: 7000 },
    "cafe latte": { harga: 9000 },
    "mokachino": { harga: 10000 },
    "vietnam drip": { harga: 9000 },
    "extra shot": { harga: 2000 },
    "gula aren": { harga: 1000 },
    "ice": { harga: 1000 },
    "hot": { harga: 0 }
  };

  // Pastikan menu default terset sekali
  db.ref("menus").once("value").then(snapshot => {
    if (!snapshot.exists()) {
      db.ref("menus").set(defaultMenus);
      console.log("✅ Default menu dimasukkan ke database.");
    }
  });
</script>
