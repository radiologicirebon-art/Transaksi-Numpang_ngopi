<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Numpang Ngopi - Kasir</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body class="bg-gray-100">

<div class="flex min-h-screen">

  <!-- Sidebar -->
  <aside class="w-64 bg-teal-700 text-white flex flex-col">
    <div class="text-2xl font-bold p-4 border-b border-teal-600">☕ Numpang Ngopi</div>
    <nav class="flex-1 p-2 space-y-2">
      <button onclick="showPage('kasir')" class="block w-full text-left px-4 py-2 hover:bg-teal-600 rounded">Kasir</button>
      <button onclick="showPage('antrian')" class="block w-full text-left px-4 py-2 hover:bg-teal-600 rounded">Antrian</button>
      <button onclick="showPage('laporan')" class="block w-full text-left px-4 py-2 hover:bg-teal-600 rounded">Laporan</button>
      <button onclick="showPage('admin')" class="block w-full text-left px-4 py-2 hover:bg-teal-600 rounded">Admin Menu</button>
    </nav>
  </aside>

  <!-- Konten Utama -->
  <main class="flex-1 p-6 overflow-y-auto">

    <!-- KASIR -->
    <section id="kasirPage" class="space-y-4">
      <h1 class="text-2xl font-bold">Kasir</h1>
      <div id="menuList" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-bold mb-2">Keranjang</h2>
        <ul id="cartList" class="mb-2"></ul>
        <p>Total: Rp<span id="total">0</span></p>
        <input id="payment" type="number" placeholder="Jumlah bayar" class="border p-2 rounded w-full mt-2">
        <input id="waNumber" type="text" placeholder="08123xxxxxxx" class="border p-2 rounded w-full mt-2">
        <button onclick="checkout()" class="bg-teal-600 text-white px-4 py-2 rounded w-full mt-2">Checkout</button>
      </div>
    </section>

    <!-- ANTRIAN -->
    <section id="antrianPage" class="hidden space-y-4">
      <h1 class="text-2xl font-bold">Antrian</h1>
      <div id="queueList" class="space-y-2"></div>
    </section>

    <!-- LAPORAN -->
    <section id="laporanPage" class="hidden space-y-4">
      <h1 class="text-2xl font-bold">Laporan</h1>
      <input type="date" id="filterTanggal" class="border p-2 rounded">
      <div id="reportList" class="space-y-2"></div>
    </section>

    <!-- ADMIN MENU -->
    <section id="adminPage" class="hidden space-y-4">
      <h1 class="text-2xl font-bold">Admin Menu</h1>
      <div id="adminMenuList" class="space-y-2"></div>
      <div class="bg-white p-4 rounded shadow space-y-2">
        <input id="newMenuKategori" placeholder="Kategori" class="border p-2 rounded w-full">
        <input id="newMenuName" placeholder="Nama Menu" class="border p-2 rounded w-full">
        <input id="newMenuPrice" type="number" placeholder="Harga" class="border p-2 rounded w-full">
        <button onclick="addMenu()" class="bg-teal-600 text-white px-4 py-2 rounded w-full">Tambah Menu</button>
      </div>
    </section>

  </main>
</div>

<script>
const firebaseConfig = {
  apiKey: "ISI_APIKEY_KAMU",
  authDomain: "ISI_DOMAIN.firebaseapp.com",
  databaseURL: "https://numpangngopi-f7462-default-rtdb.firebaseio.com/",
  projectId: "numpangngopi-f7462",
  storageBucket: "ISI_BUCKET.appspot.com",
  messagingSenderId: "ISI_MSG_ID",
  appId: "ISI_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let cart = {};
let total = 0;

function showPage(page) {
  document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
  document.getElementById(page+"Page").classList.remove("hidden");
}

function loadMenu(){
  db.ref("menu").on("value",snap=>{
    let data = snap.val()||{};
    let menuList=document.getElementById("menuList");
    let adminList=document.getElementById("adminMenuList");
    menuList.innerHTML=""; adminList.innerHTML="";
    for(let cat in data){
      data[cat].forEach((item,i)=>{
        // kasir
        let btn=document.createElement("button");
        btn.className="bg-white p-4 rounded shadow hover:bg-gray-100";
        btn.innerHTML=`<div class='font-bold'>${item.name}</div><div>Rp${item.price}</div>`;
        btn.onclick=()=>addToCart(item.name,item.price);
        menuList.appendChild(btn);
        // admin
        let row=document.createElement("div");
        row.className="flex justify-between bg-white p-2 rounded shadow";
        row.innerHTML=`<span>${cat} - ${item.name} (Rp${item.price})</span>
          <div class='space-x-2'>
            <button class='px-2 py-1 bg-yellow-500 text-white rounded' onclick="editPrice('${cat}',${i})">Ubah</button>
            <button class='px-2 py-1 bg-red-500 text-white rounded' onclick="deleteMenu('${cat}',${i})">Hapus</button>
          </div>`;
        adminList.appendChild(row);
      });
    }
  });
}
loadMenu();

function addToCart(name, harga){
  if(!cart[name]) cart[name]={qty:0,harga};
  cart[name].qty++;
  updateCart();
}
function updateCart(){
  let ul=document.getElementById("cartList");
  ul.innerHTML=""; total=0;
  for(let n in cart){
    let item=cart[n];
    let li=document.createElement("li");
    li.textContent=`${n} x${item.qty} = Rp${item.qty*item.harga}`;
    ul.appendChild(li);
    total+=item.qty*item.harga;
  }
  document.getElementById("total").textContent=total;
}

async function checkout(){
  if(total<=0) return alert("Keranjang kosong!");
  let bayar=parseInt(document.getElementById("payment").value);
  if(!bayar||bayar<total) return alert("Pembayaran kurang!");
  let phone=document.getElementById("waNumber").value.trim();
  if(!phone.startsWith("0")) return alert("Nomor harus diawali 0!");

  let phoneWA="62"+phone.slice(1);

  const snap=await db.ref("orders").orderByChild("noUrut").limitToLast(1).get();
  let last=0; snap.forEach(s=>last=s.val().noUrut||0);
  let noUrut=last+1;

  let newOrder=db.ref("orders").push();
  newOrder.set({noUrut,items:cart,total,status:"pending",time:new Date().toISOString()});

  let struk=`☕ Numpang Ngopi CRB\nNo Antrian: ${noUrut}\n=====================\n`;
  for(let menu in cart){
    let i=cart[menu]; struk+=`${menu} ${i.qty} x ${i.harga} = Rp${i.qty*i.harga}\n`;
  }
  struk+=`---------------------\nTotal: Rp${total}\nBayar: Rp${bayar}\nKembali: Rp${bayar-total}`;
  window.open(`https://wa.me/${phoneWA}?text=${encodeURIComponent(struk)}`,"_blank");

  cart={}; updateCart(); document.getElementById("payment").value=""; document.getElementById("waNumber").value="";
}

db.ref("orders").on("value",snap=>{
  let list=document.getElementById("queueList");
  list.innerHTML="";
  snap.forEach(s=>{
    let o=s.val();
    let div=document.createElement("div");
    div.className="bg-white p-2 rounded shadow flex justify-between";
    div.innerHTML=`#${o.noUrut} - Rp${o.total} <button class='bg-teal-600 text-white px-2 py-1 rounded' onclick="markDone('${s.key}')">Selesai</button>`;
    list.appendChild(div);
  });
});
function markDone(id){
  db.ref("orders/"+id).remove();
}

db.ref("transactions").on("value",snap=>showReport(snap));
document.getElementById("filterTanggal").addEventListener("change",()=>{
  db.ref("transactions").once("value").then(s=>showReport(s));
});
function showReport(snap){
  let filter=document.getElementById("filterTanggal").value;
  let list=document.getElementById("reportList");
  list.innerHTML="";
  snap.forEach(s=>{
    let t=s.val();
    if(filter && !t.time.startsWith(filter)) return;
    let div=document.createElement("div");
    div.className="bg-white p-2 rounded shadow";
    div.textContent=`${t.time} - Rp${t.total}`;
    list.appendChild(div);
  });
}

function addMenu(){
  let cat=document.getElementById("newMenuKategori").value;
  let name=document.getElementById("newMenuName").value;
  let price=parseInt(document.getElementById("newMenuPrice").value);
  if(!cat||!name||!price) return alert("Lengkapi data!");
  db.ref("menu/"+cat).once("value").then(s=>{
    let arr=s.val()||[];
    arr.push({name,price});
    db.ref("menu/"+cat).set(arr);
    document.getElementById("newMenuKategori").value="";
    document.getElementById("newMenuName").value="";
    document.getElementById("newMenuPrice").value="";
  });
}
function deleteMenu(cat,i){
  db.ref("menu/"+cat).once("value").then(s=>{
    let arr=s.val(); arr.splice(i,1);
    db.ref("menu/"+cat).set(arr);
  });
}
function editPrice(cat,i){
  let newP=prompt("Harga baru:");
  if(!newP) return;
  db.ref("menu/"+cat+"/"+i+"/price").set(parseInt(newP));
}
</script>
</body>
</html>
