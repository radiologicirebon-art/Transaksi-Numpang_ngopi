<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Numpang Ngopi CRB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Sidebar -->
  <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-lg transform -translate-x-full transition-transform z-40">
    <div class="p-4 font-bold text-xl border-b">☕ Numpang Ngopi</div>
    <nav class="p-4 space-y-2">
      <button onclick="showSection('kasir')" class="w-full text-left px-3 py-2 rounded hover:bg-gray-200">Kasir</button>
      <button onclick="showSection('antrian')" class="w-full text-left px-3 py-2 rounded hover:bg-gray-200">Antrian</button>
      <button onclick="showSection('laporan')" class="w-full text-left px-3 py-2 rounded hover:bg-gray-200">Laporan</button>
      <button onclick="showSection('adminMenu')" class="w-full text-left px-3 py-2 rounded hover:bg-gray-200">Admin Menu</button>
    </nav>
  </div>
  <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30" onclick="toggleSidebar()"></div>

  <!-- Topbar -->
  <header class="bg-white shadow p-4 flex items-center justify-between">
    <button onclick="toggleSidebar()" class="p-2 bg-gray-200 rounded">☰</button>
    <h1 id="sectionTitle" class="font-bold text-lg">Kasir</h1>
  </header>

  <!-- Main -->
  <main class="p-4">
    <!-- Kasir -->
    <section id="kasir">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-white p-4 rounded shadow">
          <h2 class="font-semibold mb-2">Pilih Menu</h2>
          <select id="menuKasir" class="border p-2 w-full mb-2"></select>
          <input id="qtyKasir" type="number" placeholder="Jumlah" class="border p-2 w-full mb-2">
          <button onclick="addToCart()" class="bg-blue-500 text-white px-4 py-2 rounded">Tambah</button>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <h2 class="font-semibold mb-2">Keranjang</h2>
          <ul id="cartList" class="mb-2"></ul>
          <p>Total: Rp <span id="totalHarga">0</span></p>
          <input id="namaPelanggan" type="text" placeholder="Nama pelanggan" class="border p-2 w-full my-2">
          <input id="bayarKasir" type="number" placeholder="Jumlah bayar" class="border p-2 w-full mb-2">
          <p>Kembalian: Rp <span id="kembalianKasir">0</span></p>
          <button onclick="checkout()" class="bg-green-500 text-white px-4 py-2 rounded">Checkout</button>
        </div>
      </div>
    </section>

    <!-- Antrian -->
    <section id="antrian" class="hidden">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-2">Antrian Pesanan</h2>
        <ul id="antrianList"></ul>
      </div>
    </section>

    <!-- Laporan -->
    <section id="laporan" class="hidden">
      <div class="bg-white p-4 rounded shadow mb-4">
        <h2 class="font-semibold mb-2">Laporan Harian</h2>
        <input id="tanggalLaporan" type="date" class="border p-2 mb-2">
        <button onclick="loadReport()" class="bg-blue-500 text-white px-4 py-2 rounded">Tampilkan</button>
        <p>Total Transaksi: <span id="totalTransaksi">0</span></p>
        <p>Omzet: Rp <span id="totalOmzet">0</span></p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <canvas id="chartLaporan" height="100"></canvas>
      </div>
    </section>

    <!-- Admin Menu -->
    <section id="adminMenu" class="hidden">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-2">Kelola Menu</h2>
        <input id="namaMenuBaru" type="text" placeholder="Nama menu" class="border p-2 mb-2">
        <input id="hargaMenuBaru" type="number" placeholder="Harga" class="border p-2 mb-2">
        <input id="kategoriMenuBaru" type="text" placeholder="Kategori" class="border p-2 mb-2">
        <button onclick="tambahMenu()" class="bg-green-500 text-white px-4 py-2 rounded mb-4">Tambah</button>
        <ul id="menuList"></ul>
      </div>
    </section>
  </main>

<script>
/* -------------------- Firebase Setup -------------------- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -------------------- Global -------------------- */
let cart = {};
let total = 0;
let chart;

/* -------------------- Kasir -------------------- */
function loadMenuKasir(){
  const select = document.getElementById("menuKasir");
  select.innerHTML = "";
  db.ref("menu").once("value").then(snap=>{
    snap.forEach(cat=>{
      cat.forEach(item=>{
        let opt=document.createElement("option");
        opt.value=JSON.stringify({name:item.val().name,price:item.val().price});
        opt.text=`${item.val().name} - Rp${item.val().price}`;
        select.appendChild(opt);
      });
    });
  });
}

function addToCart(){
  let menu=JSON.parse(document.getElementById("menuKasir").value);
  let qty=parseInt(document.getElementById("qtyKasir").value);
  if(!qty||qty<=0)return alert("Jumlah tidak valid!");
  if(!cart[menu.name]) cart[menu.name]={price:menu.price,qty:0};
  cart[menu.name].qty+=qty;
  renderCart();
}

function renderCart(){
  const list=document.getElementById("cartList");
  list.innerHTML=""; total=0;
  Object.keys(cart).forEach(k=>{
    let li=document.createElement("li");
    li.textContent=`${k} x${cart[k].qty} = Rp${cart[k].qty*cart[k].price}`;
    list.appendChild(li);
    total+=cart[k].qty*cart[k].price;
  });
  document.getElementById("totalHarga").textContent=total;
}

document.getElementById("bayarKasir").addEventListener("input",()=>{
  let bayar=parseInt(document.getElementById("bayarKasir").value)||0;
  document.getElementById("kembalianKasir").textContent=bayar-total;
});

function checkout(){
  if(Object.keys(cart).length===0)return alert("Keranjang kosong!");
  let nama=document.getElementById("namaPelanggan").value||"Umum";
  let waktu=Date.now();
  let order={nama,cart,total,status:"proses",waktu};
  db.ref("orders").push(order).then(()=>{
    alert("Pesanan masuk!");
    cart={}; renderCart();
    document.getElementById("bayarKasir").value="";
    document.getElementById("kembalianKasir").textContent="0";
  });
}

/* -------------------- Antrian -------------------- */
function loadAntrian(){
  const list=document.getElementById("antrianList");
  db.ref("orders").on("value",snap=>{
    list.innerHTML="";
    snap.forEach(o=>{
      let val=o.val();
      let li=document.createElement("li");
      li.className="flex justify-between border-b py-1";
      li.innerHTML=`<span>${val.nama} - Rp${val.total}</span>
        <button class="bg-green-500 text-white px-2 rounded" onclick="selesaiOrder('${o.key}')">Selesai</button>`;
      list.appendChild(li);
    });
  });
}
function selesaiOrder(id){
  db.ref("orders/"+id).update({status:"selesai",selesai:Date.now()});
}

/* -------------------- Laporan -------------------- */
function loadReport(){
  let tgl=document.getElementById("tanggalLaporan").value;
  if(!tgl)return alert("Pilih tanggal!");
  let start=new Date(tgl+"T00:00:00").getTime();
  let end=new Date(tgl+"T23:59:59").getTime();
  db.ref("orders").orderByChild("waktu").startAt(start).endAt(end).once("value",snap=>{
    let totalTrans=0, omzet=0;
    let perjam={}, selesaiCount={}, resp={};
    snap.forEach(o=>{
      let v=o.val();
      totalTrans++; omzet+=v.total;
      let jam=new Date(v.waktu).getHours();
      if(!perjam[jam])perjam[jam]=0;
      perjam[jam]++;
      if(v.status==="selesai"&&v.selesai){
        if(!selesaiCount[jam])selesaiCount[jam]=0;
        selesaiCount[jam]++;
        if(!resp[jam])resp[jam]=[];
        resp[jam].push((v.selesai-v.waktu)/60000);
      }
    });
    document.getElementById("totalTransaksi").textContent=totalTrans;
    document.getElementById("totalOmzet").textContent=omzet;
    renderChart(perjam,selesaiCount,resp);
  });
}

function renderChart(order,selesai,resp){
  let ctx=document.getElementById("chartLaporan").getContext("2d");
  if(chart)chart.destroy();
  let labels=[...Array(24).keys()].map(h=>h+":00");
  let dataOrder=labels.map((_,i)=>order[i]||0);
  let dataSelesai=labels.map((_,i)=>selesai[i]||0);
  let dataResp=labels.map((_,i)=>{
    if(resp[i])return resp[i].reduce((a,b)=>a+b,0)/resp[i].length;
    return 0;
  });
  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[
        {label:"Total Order",data:dataOrder,borderColor:"blue",fill:false},
        {label:"Total Selesai",data:dataSelesai,borderColor:"green",fill:false},
        {label:"Response Time (menit)",data:dataResp,borderColor:"red",fill:false}
      ]
    }
  });
}

/* -------------------- Admin Menu -------------------- */
function tambahMenu(){
  let nama=document.getElementById("namaMenuBaru").value;
  let harga=parseInt(document.getElementById("hargaMenuBaru").value);
  let kategori=document.getElementById("kategoriMenuBaru").value||"lainnya";
  if(!nama||!harga)return alert("Isi nama & harga!");
  db.ref("menu/"+kategori).once("value").then(snap=>{
    let arr=snap.val()||[];
    arr.push({name:nama,price:harga});
    db.ref("menu/"+kategori).set(arr).then(()=>{
      alert("Menu ditambahkan!");
      loadMenuKasir(); loadMenuList();
    });
  });
}
function loadMenuList(){
  const list=document.getElementById("menuList"); list.innerHTML="";
  db.ref("menu").once("value").then(snap=>{
    snap.forEach(cat=>{
      cat.forEach((item,idx)=>{
        let li=document.createElement("li");
        li.className="flex justify-between border-b py-1";
        li.innerHTML=`<span>${item.val().name} - Rp${item.val().price}</span>
          <div>
            <button class="bg-yellow-500 text-white px-2 rounded" onclick="ubahHarga('${cat.key}',${idx})">Ubah</button>
            <button class="bg-red-500 text-white px-2 rounded" onclick="hapusMenu('${cat.key}',${idx})">Hapus</button>
          </div>`;
        list.appendChild(li);
      });
    });
  });
}
function hapusMenu(kat,idx){
  db.ref("menu/"+kat).once("value").then(snap=>{
    let arr=snap.val()||[]; arr.splice(idx,1);
    db.ref("menu/"+kat).set(arr).then(()=>{
      alert("Menu dihapus!"); loadMenuKasir(); loadMenuList();
    });
  });
}
function ubahHarga(kat,idx){
  const newHarga=prompt("Harga baru:");
  if(!newHarga)return;
  db.ref("menu/"+kat).once("value").then(snap=>{
    let arr=snap.val()||[];
    if(arr[idx]){arr[idx].price=parseInt(newHarga);
      db.ref("menu/"+kat).set(arr).then(()=>{
        alert("Harga diperbarui!"); loadMenuKasir(); loadMenuList();
      });
    }
  });
}

/* -------------------- Navigasi -------------------- */
function showSection(id){
  document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.getElementById("sectionTitle").textContent=id.charAt(0).toUpperCase()+id.slice(1);
  if(id==="laporan")loadReport();
  if(id==="adminMenu")loadMenuList();
}
function toggleSidebar(){
  const sidebar=document.getElementById("sidebar");
  const overlay=document.getElementById("overlay");
  sidebar.classList.toggle("-translate-x-full");
  overlay.classList.toggle("hidden");
}

/* -------------------- Init -------------------- */
loadMenuKasir();
loadAntrian();
showSection("kasir");
</script>
</body>
</html>
