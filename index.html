<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Numpang Ngopi CRB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gray-100">

  <!-- Sidebar -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40" onclick="toggleSidebar()"></div>
  <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-white shadow transform -translate-x-full transition z-50">
    <div class="p-4 font-bold text-lg">☕ Numpang Ngopi</div>
    <nav>
      <button onclick="showSection('kasir');toggleSidebar()" class="block w-full text-left p-3 hover:bg-gray-200">Kasir</button>
      <button onclick="showSection('antrian');toggleSidebar()" class="block w-full text-left p-3 hover:bg-gray-200">Antrian</button>
      <button onclick="showSection('laporan');toggleSidebar()" class="block w-full text-left p-3 hover:bg-gray-200">Laporan</button>
      <button onclick="showSection('adminMenu');toggleSidebar()" class="block w-full text-left p-3 hover:bg-gray-200">Admin Menu</button>
    </nav>
  </aside>

  <!-- Header -->
  <header class="bg-white shadow p-4 flex items-center">
    <button onclick="toggleSidebar()" class="mr-4">☰</button>
    <h1 class="font-bold text-xl">Dashboard Numpang Ngopi</h1>
  </header>

  <!-- Main Content -->
  <main class="p-4">
    <!-- Kasir -->
    <section id="kasir" class="hidden">
      <h2 class="text-lg font-bold mb-2">Kasir</h2>
      <div>
        <select id="menuKasir" class="border p-2"></select>
        <input id="qtyKasir" type="number" placeholder="Qty" class="border p-2 w-20">
        <button onclick="addToCart()" class="bg-blue-500 text-white px-3 py-2 rounded">Tambah</button>
      </div>
      <ul id="cartList" class="mt-2"></ul>
      <div class="mt-2">Total: Rp <span id="totalCart">0</span></div>
      <input id="namaPelanggan" placeholder="Nama pelanggan" class="border p-2 mt-2 w-full">
      <input id="bayarKasir" type="number" placeholder="Bayar" class="border p-2 mt-2 w-full">
      <div>Kembalian: Rp <span id="kembalianKasir">0</span></div>
      <button onclick="checkout()" class="bg-green-500 text-white px-3 py-2 rounded mt-2">Checkout</button>
    </section>

    <!-- Antrian -->
    <section id="antrian" class="hidden">
      <h2 class="text-lg font-bold mb-2">Antrian</h2>
      <ul id="orderList"></ul>
    </section>

    <!-- Laporan -->
    <section id="laporan" class="hidden">
      <h2 class="text-lg font-bold mb-2">Laporan Harian</h2>
      <input type="date" id="tanggalLaporan" class="border p-2" onchange="loadReport()">
      <div id="reportResult" class="mt-3"></div>
      <canvas id="salesChart" class="mt-4"></canvas>
    </section>

    <!-- Admin Menu -->
    <section id="adminMenu" class="hidden">
      <h2 class="text-lg font-bold mb-2">Kelola Menu</h2>
      <div>
        <input id="menuNama" placeholder="Nama menu" class="border p-2">
        <input id="menuHarga" type="number" placeholder="Harga" class="border p-2 w-28">
        <select id="menuKategori" class="border p-2">
          <option value="coffee">Coffee</option>
          <option value="noncoffee">Non Coffee</option>
        </select>
        <button onclick="tambahMenu()" class="bg-blue-500 text-white px-3 py-2 rounded">Tambah</button>
      </div>
      <div id="menuList" class="mt-3"></div>
    </section>
  </main>

  <script>
    // Firebase config (ISI DENGAN PUNYAMU SENDIRI)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Global cart
    let cart = {};
    let total = 0;

    // --- Kasir ---
    function addToCart() {
      let menu = document.getElementById("menuKasir").value;
      let qty = parseInt(document.getElementById("qtyKasir").value);
      if (!qty || qty <= 0) return alert("Jumlah tidak valid!");
      db.ref("menus/" + menu).once("value").then(snapshot => {
        let item = snapshot.val();
        if (!item) return alert("Menu tidak ditemukan!");
        if (!cart[menu]) cart[menu] = { ...item, qty: 0 };
        cart[menu].qty += qty;
        renderCart();
      });
    }

    function renderCart() {
      let list = document.getElementById("cartList");
      list.innerHTML = "";
      total = 0;
      for (let key in cart) {
        let item = cart[key];
        total += item.price * item.qty;
        let li = document.createElement("li");
        li.textContent = `${item.name} x${item.qty} = Rp${item.price * item.qty}`;
        list.appendChild(li);
      }
      document.getElementById("totalCart").textContent = total;
      hitungKembalian();
    }

    function hitungKembalian() {
      let bayar = parseInt(document.getElementById("bayarKasir").value) || 0;
      document.getElementById("kembalianKasir").textContent = bayar - total;
    }

    function checkout() {
      let nama = document.getElementById("namaPelanggan").value;
      if (!nama) return alert("Isi nama pelanggan!");
      let now = new Date();
      let jam = now.getHours().toString().padStart(2,"0") + ":" + now.getMinutes().toString().padStart(2,"0");
      let order = { nama, items: cart, total, waktu: jam, status: "pending", selesai: null };
      db.ref("orders").push(order).then(() => {
        alert("Pesanan masuk!");
        cart = {}; total = 0;
        renderCart();
      });
    }

    // --- Antrian ---
    db.ref("orders").on("value", snap => {
      let data = snap.val();
      let list = document.getElementById("orderList");
      list.innerHTML = "";
      for (let key in data) {
        let o = data[key];
        let li = document.createElement("li");
        li.className = "border p-2 my-1";
        li.innerHTML = `<b>${o.nama}</b> - Rp${o.total} (${o.status})`;
        if (o.status === "pending") {
          let btn = document.createElement("button");
          btn.textContent = "Selesai";
          btn.className = "bg-green-500 text-white px-2 py-1 ml-2";
          btn.onclick = () => selesaiOrder(key);
          li.appendChild(btn);
        }
        list.appendChild(li);
      }
    });

    function selesaiOrder(key) {
      db.ref("orders/" + key).update({ status: "done", selesai: new Date().toISOString() });
    }

    // --- Laporan ---
    function loadReport() {
      let tanggal = document.getElementById("tanggalLaporan").value;
      db.ref("orders").once("value").then(snap => {
        let data = snap.val();
        if (!data) return;
        let totalOrder = 0, totalSelesai = 0, omzet = 0;
        let jamLabels = [], dataOrder = [], dataSelesai = [], dataResp = [];

        for (let jam=0; jam<24; jam++) {
          let lbl = jam.toString().padStart(2,"0")+":00";
          jamLabels.push(lbl);
          let oCount=0, sCount=0, respTime=0, respN=0;
          for (let key in data) {
            let o = data[key];
            if (o.waktu && o.waktu.startsWith(jam.toString().padStart(2,"0"))) {
              oCount++;
              totalOrder++;
              omzet += o.total;
              if (o.status === "done") {
                sCount++; totalSelesai++;
                if (o.selesai) {
                  let start = new Date();
                  start.setHours(parseInt(o.waktu.split(":")[0]));
                  start.setMinutes(parseInt(o.waktu.split(":")[1]));
                  let end = new Date(o.selesai);
                  let diff = (end - start)/60000;
                  respTime += diff; respN++;
                }
              }
            }
          }
          dataOrder.push(oCount);
          dataSelesai.push(sCount);
          dataResp.push(respN? (respTime/respN).toFixed(1):0);
        }

        document.getElementById("reportResult").innerHTML = `
          Total Order: ${totalOrder}<br>
          Total Selesai: ${totalSelesai}<br>
          Omzet: Rp${omzet}
        `;

        let ctx = document.getElementById("salesChart").getContext("2d");
        if (window.salesChartInstance) window.salesChartInstance.destroy();
        window.salesChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: jamLabels,
            datasets: [
              { label:"Total Order", data:dataOrder, borderColor:"blue", fill:false },
              { label:"Total Selesai", data:dataSelesai, borderColor:"green", fill:false },
              { label:"Resp Time (mnt)", data:dataResp, borderColor:"red", fill:false, yAxisID:"y1" }
            ]
          },
          options: {
            responsive:true,
            interaction:{ mode:"index" },
            stacked:false,
            scales:{
              y:{ beginAtZero:true },
              y1:{ beginAtZero:true, position:"right", grid:{ drawOnChartArea:false } }
            }
          }
        });
      });
    }

    // --- Admin Menu ---
    function tambahMenu() {
      let nama=document.getElementById("menuNama").value;
      let harga=parseInt(document.getElementById("menuHarga").value);
      let kategori=document.getElementById("menuKategori").value;
      if (!nama || !harga) return alert("Lengkapi nama & harga!");
      db.ref("menu/"+kategori).once("value").then(snap=>{
        let arr=snap.val()||[];
        arr.push({name:nama,price:harga});
        db.ref("menu/"+kategori).set(arr).then(()=>{
          alert("Menu ditambah!");
          loadMenuList();
        });
      });
    }

    function loadMenuList(){
      let div=document.getElementById("menuList");
      div.innerHTML="";
      ["coffee","noncoffee"].forEach(kat=>{
        db.ref("menu/"+kat).once("value").then(snap=>{
          let arr=snap.val()||[];
          let h=document.createElement("h3");
          h.className="font-bold mt-2";
          h.textContent=kat;
          div.appendChild(h);
          arr.forEach((m,idx)=>{
            let d=document.createElement("div");
            d.className="flex justify-between border p-1";
            d.innerHTML=`${m.name} - Rp${m.price}
              <span>
                <button onclick="ubahHarga('${kat}',${idx})" class="text-blue-500">Ubah</button>
                <button onclick="hapusMenu('${kat}',${idx})" class="text-red-500 ml-2">Hapus</button>
              </span>`;
            div.appendChild(d);
          });
        });
      });
    }

    function hapusMenu(kat, idx) {
      db.ref("menu/" + kat).once("value").then(snap => {
        let arr = snap.val() || [];
        arr.splice(idx, 1);
        db.ref("menu/" + kat).set(arr).then(() => {
          alert("Menu dihapus!");
          loadMenuList();
        });
      });
    }

    function ubahHarga(kat, idx) {
      const newHarga = prompt("Masukkan harga baru:");
      if (!newHarga) return;
      db.ref("menu/" + kat).once("value").then(snap => {
        let arr = snap.val() || [];
        if (arr[idx]) {
          arr[idx].price = parseInt(newHarga);
          db.ref("menu/" + kat).set(arr).then(() => {
            alert("Harga diperbarui!");
            loadMenuList();
          });
        }
      });
    }

    // --- Navigasi ---
    function showSection(id){
      document.querySelectorAll("main section").forEach(sec=>sec.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      if (id==="laporan") loadReport();
      if (id==="adminMenu") loadMenuList();
    }
    function toggleSidebar(){
      const sidebar=document.getElementById("sidebar");
      const overlay=document.getElementById("overlay");
      if(sidebar.classList.contains("-translate-x-full")){
        sidebar.classList.remove("-translate-x-full"); overlay.classList.remove("hidden");
      } else {
        sidebar.classList.add("-translate-x-full"); overlay.classList.add("hidden");
      }
    }

    // Default buka kasir
    showSection("kasir");
  </script>
</body>
</html>
